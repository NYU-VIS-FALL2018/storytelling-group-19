<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>goodreads book reviews</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- Plugin CSS -->
    <link href="vendor/magnific-popup/magnific-popup.css" rel="stylesheet" type="text/css">

    <!-- Custom styles for this template -->
    <link href="css/freelancer.min.css" rel="stylesheet">

  </head>

  <body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">Start Reading</a>
        <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>

      </div>
    </nav>

    <!-- Header -->
    <header class="masthead bg-primary text-white text-center">
      <div class="container">
        <img class="img-fluid mb-5 d-block mx-auto" src="img/cover.png" width="300px" height="300px"  alt="">
        <h1 class="text-uppercase mb-0">Library of stories, reviews, & ratings</h1>
        <hr class="star-light">
        <h3 class="font-weight-light mb-0">Stories are interesting! So are reviews and ratings!</h3>
        <br>
        <h3 class="font-weight-light mb-0"> We know reviews are always interesting and informative to determine the likeliness of indulging in activities and events that we are interested in. This is especially true in case of books. Before choosing our next read, we always go through ratings and reviews online, to see if the book would be of interest to us. But when the reviews are far too many, isn't it difficult to get an idea of how good the book is? This is the main reason we chose to visualize and make the task of analyzing book reviews and ratings in our storytelling task easier. </h3>
        <br>
        <h3 class="font-weight-light mb-0"> The three main aspects of visualizing any book are popularity of the book, reputation or popularity of the author, and the popular reviews.  </h3>
        <br>
        <img class="img-fluid" src="img/P.png" width="800px" height="800px" display="block"
margin-left="auto"
margin-right="auto"

alt="">
<br>
<br>
<br>
<h2 class="text-center text-uppercase text-secondary mb-0">Top 10 highly rated books</h2>
<svg id="BookChart"></svg>
<h3 class="font-weight-light mb-0"> "To Kill a Mocking Bird" is found to be most popular book, going by the ratings it has got in total. The author of the book is Harper Lee. It was published in the year 1960. Another interesting fact from this visualization is that Anne Frank has been the author for two books in the top 10 most popular books.   </h3>
<br>
<h3 class="font-weight-light mb-0"> Let's now look at popular authors, based on average ratings they got, for all the books under consideration. This is especially useful to determine if authors who wrote popular (highly rated) books are liked for their work in general. Or were there one time wonders? This is especially true, if an author X wrote a highly rated book, followed by a series of not-so-good books. His overall popularity would now be below average.</h3>
<br>
<br>
<h2 class="text-center text-uppercase text-secondary mb-0">Popularity of Authors based on Average ratings over the total number of ratings they got</h2>
<svg id="Scatterplot"></svg>
<h3 class="font-weight-light mb-0"> From this we see that Jeanine Heil is the most highly rated author, although she has been rated only once. While there are other authors like J.K. Rowling whose average rating is the highest at 4.4, with the most number of ratings in total. Ironically, Harper Lee, who wrote the most popular book, is behind many other authors like J.K. Rowling, Jane Austen, J.R.R. Tolkein in terms of overall popularity. </h3>
<br>
<h3 class="font-weight-light mb-0"> Considering the most popular author, J.K. Rowling, we can look at the word cloud of the reviews she has got as shown below. </h3>
<br>
<svg id="wordcount"></svg>
<h3 class="font-weight-light mb-0"> A word cloud is a very informative visualization when it comes to texts and words. Most repeated words get a bigger space in the word cloud. <h3>
<br>
<br>
<h3 class="font-weight-light mb-0"> This was the story of popular books and authors that have been listed on GoodReads. Hope you liked the story as much as we did. Start reading today! </h3>
    </div>
    </header>




    <!-- Footer -->
    <footer class="footer text-center">
      <div class="container">
        <div class="row">
          <div class="col-md-4 mb-5 mb-lg-0">
            <h4 class="text-uppercase mb-4">Location</h4>
            <p class="lead mb-0">NYU
              <br></p>
          </div>
          <div class="col-md-4 mb-5 mb-lg-0">
            <h4 class="text-uppercase mb-4">Around the Web</h4>
            <ul class="list-inline mb-0">
              <li class="list-inline-item">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="#">
                  <i class="fab fa-fw fa-facebook-f"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="#">
                  <i class="fab fa-fw fa-google-plus-g"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="#">
                  <i class="fab fa-fw fa-twitter"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="#">
                  <i class="fab fa-fw fa-linkedin-in"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a class="btn btn-outline-light btn-social text-center rounded-circle" href="#">
                  <i class="fab fa-fw fa-dribbble"></i>
                </a>
              </li>
            </ul>
          </div>
          <div class="col-md-4">
            <h4 class="text-uppercase mb-4">About Us</h4>
            <p class="lead mb-0">We are visualization enthusiasts. Please find our github link below
              <a href="https://nyu-vis-fall2018.github.io/storytelling-group-19/">Happy Reading!</a>.</p>
          </div>
        </div>
      </div>
    </footer>



    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-to-top d-lg-none position-fixed ">
      <a class="js-scroll-trigger d-block text-center text-white rounded" href="#page-top">
        <i class="fa fa-chevron-up"></i>
      </a>
    </div>



    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="vendor/magnific-popup/jquery.magnific-popup.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/freelancer.min.js"></script>
    <script src="d3.js" ></script>
    <script src="https://rawgit.com/jasondavies/d3-cloud/master/build/d3.layout.cloud.js"></script>
    <script>
      let store = {}
      function loadData() {
        let promise = d3.csv("https://media.githubusercontent.com/media/NYU-VIS-FALL2018/storytelling-group-19/master/br.csv")
        return promise.then(ratings => {
            store.ratings = ratings
            return store;
        })
      }

      function getScatterplotConfig() {
        let width = 600;
        let height = 400;
        var margin = { top: 10, right: 50, bottom: 130, left: 50 }
        let container = d3.select("#Scatterplot")
        container
            .attr("width", width)
            .attr("height", height)
        console.log("width", width, "height", height)
        return { width, height, margin, container }
      }

      function getWordCloudConfig() {
        let width = 400;
        let height = 400;
        var margin = { top: 10, right: 50, bottom: 130, left: 50 }
        let container = d3.select("#wordcount")
        container
            .attr("width", width)
            .attr("height", height)
        console.log("width", width, "height", height)
        return { width, height, margin, container }
      }

      function getChartConfig() {
          let width = 400;
          let height = 400;
          let margin = {
              top: 10,
              bottom: 50,
              left: 130,
              right: 10
          }
          //The body is the are that will be occupied by the bars.
          let bodyHeight = height - margin.top - margin.bottom
          let bodyWidth = width - margin.left - margin.right

          let container = d3.select("#AuthorChart")
          container
              .attr("width", width)
              .attr("height", height)
          // console.log("width", width, "height", height, "margin", margin, "bodyHeight", bodyHeight, "bodyWidth", bodyWidth)

          return { width, height, margin, bodyHeight, bodyWidth, container }
      }

      function getChartScales(ratings, config) {
          let { bodyWidth, bodyHeight } = config;
          console.log("bodyHeight", bodyHeight, "bodyWidth", bodyWidth)
          let maximunCount = d3.max(ratings, d => d.Count)
          console.log("maximunCount", maximunCount)
          let xScale = d3.scaleLinear()
              .range([0, bodyWidth])
              .domain([0, maximunCount])

          let yScale = d3.scaleBand()
              .range([0, bodyHeight])
              .domain(ratings.map(a => a.AuthorName)) //The domain is the list of author's names
              .padding(0.2)

          return { xScale, yScale }
      }

      function groupByAuthor(data){
          //Iterate over each route, producing a dictionary where the keys is are the ailines ids and the values are the information of the airline.
          let result = data.reduce((result, d) => {
              let currentData = result[d.author] || {
                  "AuthorName": d.author,
                  "rating": d.rating,
                  "ratingsCount": d.ratingsCount,
                  "Count": 0
              }

              currentData.Count += parseInt(currentData.rating)

              result[d.author] = currentData

              return result;
          }, {});

          result = Object.keys(result).map(key => result[key])

          result = result.sort(function(d1,d2) {
            return d3.descending(d1.Count, d2.Count);
          })

          return result.slice(0,10)

      }


      function drawBars(ratings, scales, config) {
        let {margin, container} = config; // this is equivalent to 'let margin = config.margin; let container = config.container'
        let {xScale, yScale} = scales
        console.log("xScale", xScale, "yScale", yScale)
        let body = container.append("g")
            .style("transform",
              `translate(${margin.left}px,${margin.top}px)`
            )

        let bars = body.selectAll(".bar")
            .data(ratings)
            // console.log(bars);

        //Adding a rect tag for each airline
        bars.enter().append("rect")
            .attr("height", yScale.bandwidth())
            .attr("y", (d) => yScale(d.AuthorName))

            // .attr("width", xScale.scaleBand())
            .attr("width", d => xScale(d.Count))
            .attr("fill", "#2a5599")
      }

      function drawAxes(ratings, scales, config){
        let {xScale, yScale} = scales
        let {container, margin, height} = config;
        let axisX = d3.axisBottom(xScale)
                      .ticks(5)

        container.append("g")
          .style("transform",
              `translate(${margin.left}px,${height - margin.bottom}px)`
          )
          .call(axisX)

        let axisY = d3.axisLeft(yScale)
        container.append("g")
          .style("transform",
              `translate(${margin.left}px, ${margin.top}px)`
          )
          .call(axisY)
      }

      function drawAxesforScatterplot(ratings, scales, config){
        let {xScale, yScale} = scales
        let {container, margin, height} = config;
        let axisX = d3.axisBottom(xScale)
                      .ticks(5)

        container.append("g")
          .style("transform",
              `translate(${margin.left}px,${height - margin.bottom}px)`
          )
          .call(axisX)

        let axisY = d3.axisLeft(yScale)
        container.append("g")
          .style("transform",
              `translate(${margin.left}px, ${margin.top}px)`
          )
          .call(axisY)
      }

      function drawBarChart(ratings) {
        let config = getChartConfig();
        let scales = getChartScales(ratings, config);

        drawBars(ratings, scales, config);
        drawAxes(ratings, scales, config);
      }

      function drawScatterplot(ratings) {
        let config = getScatterplotConfig();
        console.log("config: ", config)
        let w = config.width
        let h = config.height
        let container = config.container
        console.log("w: ", w, "h: ", h)
        // var formatPercent = d3.format('.2%')
        var body = d3.select('Scatterplot')
        var margin = config.margin
        let bodyHeight = h - margin.top - margin.bottom
        let bodyWidth = w - margin.left - margin.right
        // Scales
        // var colorScale = d3.scaleOrdinal(d3.category20)
                            // .range([0,400])

        var colorScale = d3.scaleSequential()
          .domain([0, ratings.length])
          .interpolator(d3.interpolateRainbow);

        var xScale = d3.scaleLinear()
          .domain([0, d3.max(ratings, d => parseInt(d.ratingsCount) )])
          // .domain([0, 120000])
          .range([0, bodyWidth])
          console.log("xMax: ", d3.max(ratings, d => parseInt(d.ratingsCount) ))
        var yScale = d3.scaleLinear()
          .domain([0,  d3.max(ratings, d => parseInt(d.rating) )])
          // .domain([0, 2000])
          .range([bodyHeight, 0])
          //.append('text',"Average ratings")
          console.log("yMax: ", d3.max(ratings, d => parseInt(d.rating) ))
      	// SVG
      	var svg = container.append('svg')
      	    .attr('height', h + margin.top + margin.bottom)
      	    // .attr('width',w + margin.left + margin.right)
            // .attr('height',h)
      	    .attr('width', w)
      	  .append('g')
      	    .attr('transform','translate(' + margin.left + ',' + margin.top + ')')


        // Circles
        var circles = svg.selectAll('circle')
            .data(ratings)
            .enter()
          .append('circle')
            .attr('cx',function (d) { return xScale(d.ratingsCount) })
            .attr('cy',function (d) { return yScale(d.rating) })
            .attr('r','5')
            .attr('stroke','black')
            .attr('stroke-width',1)
            .attr('fill',function (d,i) { return colorScale(i) })
            .on('mouseover', function () {
              d3.select(this)
                .transition()
                .duration(500)
                .attr('r',20)
                .attr('stroke-width',3)
            })
            .on('mouseout', function () {
              d3.select(this)
                .transition()
                .duration(500)
                .attr('r',10)
                .attr('stroke-width',1)
            })
          .append('title') // Tooltip
            .text(function (d) { return d.author +
                                 '\nRatingsCount: ' + d.ratingsCount +
                                 '\nAverage Rating: ' + d.rating })


        let scales = {xScale, yScale}
        drawAxesforScatterplot(ratings, scales, config);
      }
      var words = []

        function wordCloud(selector) {
            let config = getWordCloudConfig();
            console.log("config: ", config)
            let w = config.width
            let h = config.height
            let container = config.container
            var margin = config.margin
            var colorfill = d3.scaleOrdinal(d3.schemeCategory20);
            var colorScale = d3.scaleSequential()
                .domain([0, 21])
                .interpolator(d3.interpolateRainbow);


            var color = d3.scaleLinear()
                .domain([0, 15, 30])
                .range(["red", "white", "green"]);

            var svg = container.append("svg")
                .attr("width", w)
                .attr("height", h + margin.top + margin.bottom)
                .append("g")
                // .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                .attr("transform", "translate(200,200)");

            //Draw the word cloud
            function draw(words) {
                var cloud = svg.selectAll("g text")
                                .data(words, function(d) { return d.text; })
                //Entering words
                cloud.enter()
                    .append("text")
                    .style("font-family", "Impact")
                  //   .attr("transform", function (d) {
                  //       return "translate(" + [d.x + 600, d.y + 800] + ")";
                  //   })
                  //   .style("fill", function(d, i) { return colorfill(i); })
                  //   .attr("fill", d => color(d))
                    .attr("fill", function(d,i) { return color(i)})
                  //   .attr('fill', function (d, i) {
                  //       console.log("color i " + i)
                  //       return color(i) })
                    .attr("text-anchor", "middle")
                    .style("font-size", function (d) { return d.size + "px"; })
                    .attr("transform", function (d) {
                        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                      //   return "rotate(" + d.rotate + ")";
                    })
                  //   .attr('font-size', 30)
                    .text(function(d) {
                      //   console.log("text : " + d.text)
                        return d.text; });
                //Entering and existing words
                cloud.transition()
                        .duration(1000)
                        .style("font-size", function(d) { return d.size + "px"; })
                        .attr("transform", function(d) {
                            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                        })
                        .style("fill-opacity", 1);
                //Exiting words
                cloud.exit()
                    .transition()
                        .duration(200)
                        .style('fill-opacity', 1e-6)
                        .attr('font-size', 1)
                        .remove();
            }
            var sizeScale = d3.scaleLinear()
                .domain([0, d3.max(words, function (d) { return d.text })])
                .range([10, 95]); // 95 because 100 was causing stuff to be missing
            //Use the module pattern to encapsulate the visualisation code. We'll
            // expose only the parts that need to be public.
            return {
                //Recompute the word cloud for a new set of words. This method will
                // asycnhronously call draw when the layout has been computed.
                //The outside world will need to call this function, so make it part
                // of the wordCloud return value.
                update: function(words) {
                    d3.layout.cloud().size([400, 400])
                        .words(words)
                        .padding(5)
                        .text(function (d) { return d.text; })
                        .rotate(function() { return ~~(Math.random() * 2) * 90; })
                      //   .rotate(function (d) { return 0; })
                        .font("Impact")
                      //   .fontSize(20)
                      //   .fontSize(function (d) { return sizeScale(d.size); })
                        .fontSize(function(d) { return d.size; })
                        .on("end", draw)
                        .start();
                }
            }
        }

        //Prepare one of the sample sentences by removing punctuation,
        // creating an array of words and computing a random size attribute.
        function getWords(i) {
            return words[i]
                    .replace(/[!\.,:;\?]|a|the|his|so|by|for|And|with|much|he's/g, '')
                    .split(' ')
                    .map(function(d) {
                        return {text: d, size: 10 + Math.random() * 60};
                    })
        }
        //This method tells the word cloud to redraw with a new set of words.
        //In reality the new words would probably come from a server request,
        // user input or some other source.
        function showNewWords(vis, i) {
            i = i || 0;
            vis.update(getWords(i ++ % words.length))
          //  setTimeout(function() { showNewWords(vis, i + 1)}, 2000)
        }


        function wordCountFunc(ratings) {
          reviewList = []
          mostCommonWords = []
          tmp = []
          result = []
          reviews = ratings.filter(function(d) {return d.author == "J.K. Rowling" && d.review != "";})
          reviews.map(function(d) {reviewList.push(d.review);})
          var descString = "";
          reviewList.map(function(d) {
              descString += d + " ";
          });
          var descArray = descString.split(" ");

          var descObjects = [];

          descArray.forEach(function(d) {
              var descObject = {}
              descObject.description = d;
              descObjects.push(descObject);
          });

          var wordCount = d3.nest()
                            .key(function(d) { return d.description; })
                            .rollup(function(v) { return v.length; })
                            .entries(descObjects);
          wordCount.sort(function(a,b){ return d3.descending(a.value, b.value); })
          wordCount = wordCount.slice(0,50);
          wordCount.map(function(d) { mostCommonWords.push(d.key); })
          mostCommonWords.map(function(d) {
              // result.push(d)
              tmp += d + " ";
          });
          result.push(tmp)
          // var tags = [];
          //
          // wordCount.forEach(function(d) {
          //   tags.push([d.key,parseInt(d.values)]);
          // });
          //
          // tags = tags.slice(0,250);
          //
          // console.log("descObjects : ", descObjects)
          console.log("wordCount : ", wordCount)
          console.log("result : ", result)

          return result

        }


        function getChartConfig1() {
            let width = 800;
            let height = 600;
            let margin = {
                top: 10,
                bottom: 50,
                left: 130,
                right: 10
            }
            //The body is the are that will be occupied by the bars.
            let bodyHeight = height - margin.top - margin.bottom
            let bodyWidth = width - margin.left - margin.right

            let container = d3.select("#BookChart")
            container
                .attr("width", width)
                .attr("height", height)
            // console.log("width", width, "height", height, "margin", margin, "bodyHeight", bodyHeight, "bodyWidth", bodyWidth)

            return { width, height, margin, bodyHeight, bodyWidth, container }
        }

        function getChartScales1(ratings, config) {
            let { bodyWidth, bodyHeight } = config;
            console.log("bodyHeight", bodyHeight, "bodyWidth", bodyWidth)
            let maximunCount = d3.max(ratings, d => parseInt(d.ratingsCount))
            console.log("maximunCount", maximunCount)
            let xScale = d3.scaleLinear()
                .range([0, bodyWidth])
                .domain([0, maximunCount])

            let yScale = d3.scaleBand()
                .range([0, bodyHeight])
                .domain(ratings.map(a => a.title)) //The domain is the list of author's names
                .padding(0.2)

            return { xScale, yScale }
        }

        function groupByBook1(data){
            //Iterate over each route, producing a dictionary where the keys is are the ailines ids and the values are the information of the airline.
            let result = data.reduce((result, d) => {
                let currentData = result[d.title] || {
                    "title": d.title,
                    "author": d.author,
                    "ratingsCount": parseInt(d.ratingsCount)
                }

                // currentData.Count += parseInt(currentData.rating)

                // * currentData.ratingsCount
                // console.log(parseInt(currentData.rating))

                result[d.author] = currentData

                return result;
            }, {});

            result = Object.keys(result).map(key => result[key])

            result = result.sort(function(d1,d2) {
              return d3.descending(d1.ratingsCount, d2.ratingsCount);
            })

            return result.slice(0,10)

        }

        function drawAxes1(ratings, scales, config){
          let {xScale, yScale} = scales
          let {container, margin, height} = config;
          let axisX = d3.axisBottom(xScale)
                        .ticks(5)

          container.append("g")
            .style("transform",
                `translate(${margin.left}px,${height - margin.bottom}px)`
            )
            .call(axisX)

          let axisY = d3.axisLeft(yScale)
          container.append("g")
            .style("transform",
                `translate(${margin.left}px, ${margin.top}px)`
            )
            .call(axisY)
        }

        function drawBars1(ratings, scales, config) {
          let {margin, container} = config; // this is equivalent to 'let margin = config.margin; let container = config.container'
          let {xScale, yScale} = scales
          console.log("xScale", xScale, "yScale", yScale)
          let body = container.append("g")
              .style("transform",
                `translate(${margin.left}px,${margin.top}px)`
              )

          let bars = body.selectAll(".bar")
              .data(ratings)
              // console.log(bars);

          //Adding a rect tag for each airline
          bars.enter().append("rect")
              .attr("height", yScale.bandwidth())
              .attr("y", (d) => yScale(d.title))

              // .attr("width", xScale.scaleBand())
              .attr("width", d => xScale(d.ratingsCount))
              .attr("fill", "gray")
              .on("mouseover", function() {
                  d3.select(this)
                  	.attr("fill", "#2a5599");
              })
              .on("mouseout", function(d, i) {
                  d3.select(this).attr("fill", function() {
                      return "gray";
                  });
              })
              .append('title') // Tooltip
                .text(function (d) { return d.author})
        }

        function drawBarChart1(ratings) {
          let config = getChartConfig1();
          let scales = getChartScales1(ratings, config);

          drawBars1(ratings, scales, config);
          drawAxes1(ratings, scales, config);
        }
      function showData() {

      //  let routes = store.routes
        let ratings = store.ratings
        let ratingBar = groupByAuthor(ratings);
        let ratingBar1 = groupByBook1(ratings);

        drawBarChart(ratingBar)
        // getScatterplotConfig()
        drawScatterplot(ratings.slice(0,10000))
        var myWordCloud = wordCloud("#wordcount");
        words = wordCountFunc(ratings)
        //Start cycling through the demo data
        showNewWords(myWordCloud);
        console.log("ratings: ", ratingBar);
        drawBarChart1(ratingBar1)

      }



      loadData().then(showData);
      </script>

  </body>
  <style>
  .bar :hover {
	fill: orange;
}
</style>

</html>
