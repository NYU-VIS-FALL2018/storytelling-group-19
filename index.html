<html>
<script src="d3.js" ></script>
<head>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif
        }

        h1 {
            background-color: #2a5599;
            color: white;
            padding: 25px;
        }

        svg{
            border: 1px solid black;
        }

        .mainView{
            display: flex;
        }
        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
        }

        .dot {
          stroke: #000;
        }

        .tooltip {
          position: absolute;
          width: 200px;
          height: 28px;
          pointer-events: none;
        }

    </style>
</head>

<body>
    <script>
      let store = {}
      function loadData() {
        return Promise.all([
            d3.csv("routes.csv"),
            d3.json("countries.geo.json"),
            d3.csv("Aid Data Countries - Aggregated.csv"),
            d3.csv("br.csv")
        ]).then(datasets => {
            store.routes = datasets[0];
            store.geoJSON = datasets[1];
            store.aidCountries = datasets[2];
            store.ratings = datasets[3];
            return store;
        })
      }

      function getScatterplotConfig() {
        let width = 600;
        let height = 400;
        var margin = { top: 10, right: 50, bottom: 130, left: 50 }
        let container = d3.select("#Scatterplot")
        container
            .attr("width", width)
            .attr("height", height)
        console.log("width", width, "height", height)
        return { width, height, margin, container }
      }

      function getChartConfig() {
          let width = 400;
          let height = 400;
          let margin = {
              top: 10,
              bottom: 50,
              left: 130,
              right: 10
          }
          //The body is the are that will be occupied by the bars.
          let bodyHeight = height - margin.top - margin.bottom
          let bodyWidth = width - margin.left - margin.right

          let container = d3.select("#AuthorChart")
          container
              .attr("width", width)
              .attr("height", height)
          // console.log("width", width, "height", height, "margin", margin, "bodyHeight", bodyHeight, "bodyWidth", bodyWidth)

          return { width, height, margin, bodyHeight, bodyWidth, container }
      }

      function getChartScales(ratings, config) {
          let { bodyWidth, bodyHeight } = config;
          console.log("bodyHeight", bodyHeight, "bodyWidth", bodyWidth)
          let maximunCount = d3.max(ratings, d => d.Count)
          console.log("maximunCount", maximunCount)
          let xScale = d3.scaleLinear()
              .range([0, bodyWidth])
              .domain([0, maximunCount])

          let yScale = d3.scaleBand()
              .range([0, bodyHeight])
              .domain(ratings.map(a => a.AuthorName)) //The domain is the list of author's names
              .padding(0.2)

          return { xScale, yScale }
      }

      function groupByAuthor(data){
          //Iterate over each route, producing a dictionary where the keys is are the ailines ids and the values are the information of the airline.
          let result = data.reduce((result, d) => {
              let currentData = result[d.author] || {
                  "AuthorName": d.author,
                  "rating": d.rating,
                  "ratingsCount": d.ratingsCount,
                  "Count": 0
              }

              currentData.Count += parseInt(currentData.rating)

              // * currentData.ratingsCount
              // console.log(parseInt(currentData.rating))

              result[d.author] = currentData

              return result;
          }, {});

          result = Object.keys(result).map(key => result[key])

          result = result.sort(function(d1,d2) {
            return d3.descending(d1.Count, d2.Count);
          })

          return result.slice(0,10)

      }

      // function groupByBooks(data){
      //
      // }


      function drawBars(ratings, scales, config) {
        let {margin, container} = config; // this is equivalent to 'let margin = config.margin; let container = config.container'
        let {xScale, yScale} = scales
        console.log("xScale", xScale, "yScale", yScale)
        let body = container.append("g")
            .style("transform",
              `translate(${margin.left}px,${margin.top}px)`
            )

        let bars = body.selectAll(".bar")
            .data(ratings)
            // console.log(bars);

        //Adding a rect tag for each airline
        bars.enter().append("rect")
            .attr("height", yScale.bandwidth())
            .attr("y", (d) => yScale(d.AuthorName))

            // .attr("width", xScale.scaleBand())
            .attr("width", d => xScale(d.Count))
            .attr("fill", "#2a5599")
      }

      function drawAxes(ratings, scales, config){
        let {xScale, yScale} = scales
        let {container, margin, height} = config;
        let axisX = d3.axisBottom(xScale)
                      .ticks(5)

        container.append("g")
          .style("transform",
              `translate(${margin.left}px,${height - margin.bottom}px)`
          )
          .call(axisX)

        let axisY = d3.axisLeft(yScale)
        container.append("g")
          .style("transform",
              `translate(${margin.left}px, ${margin.top}px)`
          )
          .call(axisY)
      }

      function drawAxesforScatterplot(ratings, scales, config){
        let {xScale, yScale} = scales
        let {container, margin, height} = config;
        let axisX = d3.axisBottom(xScale)
                      .ticks(5)

        container.append("g")
          .style("transform",
              `translate(${margin.left}px,${height - margin.bottom}px)`
          )
          .call(axisX)

        let axisY = d3.axisLeft(yScale)
        container.append("g")
          .style("transform",
              `translate(${margin.left}px, ${margin.top}px)`
          )
          .call(axisY)
      }

      function drawBarChart(ratings) {
        let config = getChartConfig();
        let scales = getChartScales(ratings, config);

        drawBars(ratings, scales, config);
        drawAxes(ratings, scales, config);
      }

      function drawScatterplot(ratings) {
        let config = getScatterplotConfig();
        console.log("config: ", config)
        let w = config.width
        let h = config.height
        let container = config.container
        console.log("w: ", w, "h: ", h)
        // var formatPercent = d3.format('.2%')
        var body = d3.select('Scatterplot')
        var margin = config.margin
        let bodyHeight = h - margin.top - margin.bottom
        let bodyWidth = w - margin.left - margin.right
        // Scales
        // var colorScale = d3.scaleOrdinal(d3.category20)
                            // .range([0,400])

        var colorScale = d3.scaleSequential()
          .domain([0, ratings.length])
          .interpolator(d3.interpolateRainbow);

        var xScale = d3.scaleLinear()
          .domain([0, d3.max(ratings, d => parseInt(d.ratingsCount) )])
          // .domain([0, 120000])
          .range([0, bodyWidth])
          console.log("xMax: ", d3.max(ratings, d => parseInt(d.ratingsCount) ))
        var yScale = d3.scaleLinear()
          .domain([0,  d3.max(ratings, d => parseInt(d.reviewsCount) )])
          // .domain([0, 2000])
          .range([bodyHeight, 0])
          console.log("yMax: ", d3.max(ratings, d => parseInt(d.reviewsCount) ))
      	// SVG
      	var svg = container.append('svg')
      	    .attr('height',h + margin.top + margin.bottom)
      	    // .attr('width',w + margin.left + margin.right)
            // .attr('height',h)
      	    .attr('width',w)
      	  .append('g')
      	    .attr('transform','translate(' + margin.left + ',' + margin.top + ')')

      	// // X-axis
      	// var xAxis = d3.axisBottom(xScale)
      	//   // .tickFormat(formatPercent)
        //   // .orient("bottom")
      	//   .ticks(5)
        // // Y-axis
      	// var yAxis = d3.axisLeft(yScale)
      	//   // .tickFormat(formatPercent)
        //   // .orient("left")
      	//   .ticks(5)
        // Circles
        var circles = svg.selectAll('circle')
            .data(ratings)
            .enter()
          .append('circle')
            .attr('cx',function (d) { return xScale(d.ratingsCount) })
            .attr('cy',function (d) { return yScale(d.reviewsCount) })
            .attr('r','5')
            .attr('stroke','black')
            .attr('stroke-width',1)
            .attr('fill',function (d,i) { return colorScale(i) })
            .on('mouseover', function () {
              d3.select(this)
                .transition()
                .duration(500)
                .attr('r',20)
                .attr('stroke-width',3)
            })
            .on('mouseout', function () {
              d3.select(this)
                .transition()
                .duration(500)
                .attr('r',10)
                .attr('stroke-width',1)
            })
          .append('title') // Tooltip
            .text(function (d) { return d.author +
                                 '\nReviewsCount: ' + d.reviewsCount +
                                 '\nRatingsCount: ' + d.ratingsCount })
        // // X-axis
        // svg.append('g')
        //     .attr('class','axis')
        //     .attr('transform', 'translate(' + margin.left + "," + h + ')')
        //     // .attr('transform', 'translate(0,' + margin.bottom + 10 + ')')
        //     .call(xAxis)
        //   .append('text') // X-axis Label
        //     .attr('class','label')
        //     .attr('y',10)
        //     .attr('x',0)
        //     .attr('transform','rotate(-180)')
        //     // .attr('dy','.71em')
        //     .style('text-anchor','end')
        //     .text('Annualized Standard Deviation')
        // // Y-axis
        // svg.append('g')
        //     .attr('class', 'axis')
        //     // .attr('transform', 'translate(' + margin.left + "," + margin.top + ')')
        //     .call(yAxis)
        //   .append('text') // y-axis Label
        //     .attr('class','label')
        //     // .attr('transform','rotate(-90)')
        //     .attr('x',0)
        //     .attr('y',10)
        //     // .attr('dy','.71em')
        //     .style('text-anchor','end')
        //     .text('Annualized Return')

        let scales = {xScale, yScale}
        drawAxesforScatterplot(ratings, scales, config);
      }

      function showData() {

        let routes = store.routes
        let ratings = store.ratings
        let ratingBar = groupByAuthor(ratings);

        drawBarChart(ratingBar)
        // getScatterplotConfig()
        drawScatterplot(ratings.slice(0,10000))

      }

      loadData().then(showData);
    </script>

    <h1>Final Project - Good Book Review</h1>
    <div class="mainView">
        <div>
            <h3>Most famous author</h3>
            <svg id="AuthorChart"></svg>
        </div>
        <div>
            <h3>Relationship between reviewsCount and ratingsCount</h3>
            <svg id="Scatterplot"></svg>
        </div>
    </div>
</body>

</html>
